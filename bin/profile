#!/usr/bin/env bash
set -euo pipefail
if [[ $# -ne 1 ]]; then
  echo "usage: bin/profile <local-dev|hpc-slurm|cloud-aws|cloud-gcp|ci|viz-hi-mem|ariel-2025>" >&2
  exit 2
fi
name="$1"
src="configs/symbolic/overrides/profiles/${name}.yaml"
dst="configs/profiles/active.yaml"
[[ -f "$src" ]] || { echo "unknown profile: $name" >&2; exit 3; }
ln -snf "../symbolic/overrides/profiles/${name}.yaml" "$dst"

# gather context
ts="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
git_hash="$(git rev-parse --short HEAD 2>/dev/null || echo 'NA')"
env_short="$(env | egrep '^(ARIEL_|SMV50_|MLFLOW_|WANDB_|S3_|GCS_)' | sort | tr -d '\n' | sed 's/"/\\"/g')"

# write JSONL event
mkdir -p var/events
printf '{"ts":"%s","event":"profile_switch","profile":"%s","git":"%s","env":"%s"}\n' \
  "$ts" "$name" "$git_hash" "$env_short" >> var/events/events.jsonl

# friendly git commit (optional)
if git rev-parse --git-dir >/dev/null 2>&1; then
  git add configs/profiles/active.yaml var/events/events.jsonl
  git commit -m "chore(config): switch active profile -> ${name}"
fi

echo "active profile -> ${name}"
